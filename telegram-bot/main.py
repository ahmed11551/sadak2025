import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from aiogram.utils.keyboard import InlineKeyboardBuilder
from pydantic_settings import BaseSettings
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
class Settings(BaseSettings):
    telegram_bot_token: str = os.getenv("TELEGRAM_BOT_TOKEN", "")
    webapp_url: str = os.getenv("TELEGRAM_WEBAPP_URL", "https://your-domain.com")
    database_url: str = os.getenv("DATABASE_URL", "postgresql://sadaka_user:sadaka_password@localhost:5432/sadaka_pass")
    
    class Config:
        env_file = ".env"

settings = Settings()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
bot = Bot(token=settings.telegram_bot_token)
dp = Dispatcher()

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def get_main_menu() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    builder.add(InlineKeyboardButton(
        text="üïå –û—Ç–∫—Ä—ã—Ç—å Sadaka-Pass",
        web_app=WebAppInfo(url=settings.webapp_url)
    ))
    
    builder.add(InlineKeyboardButton(
        text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        callback_data="stats"
    ))
    
    builder.add(InlineKeyboardButton(
        text="‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ",
        callback_data="about"
    ))
    
    builder.add(InlineKeyboardButton(
        text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        callback_data="support"
    ))
    
    builder.adjust(1)
    return builder.as_markup()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(CommandStart())
async def start_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = message.from_user
    
    welcome_text = f"""
üïå <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Sadaka-Pass!</b>

–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã

<b>Sadaka-Pass</b> ‚Äî —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è:
‚Ä¢ üí∞ –†–∞–∑–æ–≤—ã—Ö –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π
‚Ä¢ üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (—Å–∞–¥–∞–∫–∞-–¥–∂–∞—Ä–∏—è)
‚Ä¢ üßÆ –†–∞—Å—á–µ—Ç–∞ –∏ –æ–ø–ª–∞—Ç—ã –∑–∞–∫—è—Ç–∞
‚Ä¢ ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ —Å —Ñ–æ–Ω–¥–∞–º–∏

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
    """
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@dp.message(Command("help"))
async def help_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
<b>üìñ –ü–æ–º–æ—â—å –ø–æ Sadaka-Pass</b>

<b>–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>
‚Ä¢ <b>–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è</b> ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–µ–ª–µ–π
‚Ä¢ <b>–ü–æ–¥–ø–∏—Å–∫–∏</b> ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤–∑–Ω–æ—Å—ã
‚Ä¢ <b>–ó–∞–∫—è—Ç</b> ‚Äî —Ä–∞—Å—á–µ—Ç –∏ –æ–ø–ª–∞—Ç–∞ –∑–∞–∫—è—Ç–∞
‚Ä¢ <b>–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ</b> ‚Äî –ø–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ

<b>–ö–æ–º–∞–Ω–¥—ã:</b>
/start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

<b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</b>
‚úÖ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞—â–∏—â–µ–Ω—ã
‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å
‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ–Ω–¥—ã

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–¥–µ—Ä–∂–∫–∞" –≤ –º–µ–Ω—é.
    """
    
    await message.answer(help_text, parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats
@dp.message(Command("stats"))
async def stats_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats"""
    stats_text = """
<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Sadaka-Pass</b>

<b>–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</b>
‚Ä¢ üí∞ –í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ: <b>2,400,000 ‚ÇΩ</b>
‚Ä¢ üéØ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π: <b>1,247</b>
‚Ä¢ üè¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ–Ω–¥–æ–≤: <b>89</b>
‚Ä¢ üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>3,456</b>

<b>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü:</b>
‚Ä¢ üí∞ –°–æ–±—Ä–∞–Ω–æ: <b>156,000 ‚ÇΩ</b>
‚Ä¢ üéØ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π: <b>89</b>
‚Ä¢ üßÆ –†–∞—Å—á–µ—Ç–æ–≤ –∑–∞–∫—è—Ç–∞: <b>234</b>

<b>–¢–æ–ø —Ñ–æ–Ω–¥—ã:</b>
1. üïå –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º–µ—á–µ—Ç–∏ ‚Äî 450,000 ‚ÇΩ
2. üë∂ –ü–æ–º–æ—â—å –¥–µ—Ç—è–º ‚Äî 320,000 ‚ÇΩ
3. üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å ‚Äî 280,000 ‚ÇΩ

<i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</i>
    """
    
    await message.answer(stats_text, parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∑–∞–ø—Ä–æ—Å–æ–≤
@dp.callback_query()
async def callback_handler(callback: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∑–∞–ø—Ä–æ—Å–æ–≤"""
    data = callback.data
    
    if data == "stats":
        await callback.message.edit_text(
            """
<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Sadaka-Pass</b>

<b>–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</b>
‚Ä¢ üí∞ –í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ: <b>2,400,000 ‚ÇΩ</b>
‚Ä¢ üéØ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π: <b>1,247</b>
‚Ä¢ üè¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ–Ω–¥–æ–≤: <b>89</b>
‚Ä¢ üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>3,456</b>

<b>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü:</b>
‚Ä¢ üí∞ –°–æ–±—Ä–∞–Ω–æ: <b>156,000 ‚ÇΩ</b>
‚Ä¢ üéØ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π: <b>89</b>
‚Ä¢ üßÆ –†–∞—Å—á–µ—Ç–æ–≤ –∑–∞–∫—è—Ç–∞: <b>234</b>

<b>–¢–æ–ø —Ñ–æ–Ω–¥—ã:</b>
1. üïå –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º–µ—á–µ—Ç–∏ ‚Äî 450,000 ‚ÇΩ
2. üë∂ –ü–æ–º–æ—â—å –¥–µ—Ç—è–º ‚Äî 320,000 ‚ÇΩ
3. üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å ‚Äî 280,000 ‚ÇΩ

<i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</i>
            """,
            parse_mode="HTML",
            reply_markup=get_main_menu()
        )
    
    elif data == "about":
        await callback.message.edit_text(
            """
<b>‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ Sadaka-Pass</b>

<b>–ú–∏—Å—Å–∏—è:</b>
–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –∏ —É–¥–æ–±–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –º—É—Å—É–ª—å–º–∞–Ω, –ø–æ–∑–≤–æ–ª—è—é—â—É—é –ª–µ–≥–∫–æ —Å–æ–≤–µ—Ä—à–∞—Ç—å –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –∑–∞–∫—è—Ç.

<b>–ü—Ä–∏–Ω—Ü–∏–ø—ã:</b>
‚Ä¢ üïã –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å–ª–∞–º—Å–∫–∏–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º
‚Ä¢ üîç 100% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤
‚Ä¢ üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π
‚Ä¢ üåç –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö –º—É—Å—É–ª—å–º–∞–Ω

<b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:</b>
‚Ä¢ ü§ñ Telegram Mini App
‚Ä¢ üîí –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
‚Ä¢ üìä –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å
‚Ä¢ üåê –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (RU/EN/AR)

<b>–ö–æ–º–∞–Ω–¥–∞:</b>
–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π –º—É—Å—É–ª—å–º–∞–Ω—Å–∫–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å –æ–ø—ã—Ç–æ–º –≤ —Ñ–∏–Ω—Ç–µ—Ö–µ –∏ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

<i>–î–∞ –≤–æ–∑–¥–∞—Å—Ç –ê–ª–ª–∞—Ö –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –ø—Ä–æ–µ–∫—Ç–∞ –±–ª–∞–≥–æ–º!</i>
            """,
            parse_mode="HTML",
            reply_markup=get_main_menu()
        )
    
    elif data == "support":
        await callback.message.edit_text(
            """
<b>üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞</b>

<b>–°–ø–æ—Å–æ–±—ã —Å–≤—è–∑–∏:</b>
‚Ä¢ üìß Email: support@sadaka-pass.com
‚Ä¢ üí¨ Telegram: @sadaka_pass_support
‚Ä¢ üåê –°–∞–π—Ç: sadaka-pass.com

<b>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</b>
–ü–Ω-–ü—Ç: 9:00 - 18:00 (–ú–°–ö)
–°–±-–í—Å: 10:00 - 16:00 (–ú–°–ö)

<b>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</b>
‚Ä¢ –ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–∫—è—Ç? ‚Äî –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã –ª–∏ –ø–ª–∞—Ç–µ–∂–∏? ‚Äî –î–∞, –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞—â–∏—â–µ–Ω—ã
‚Ä¢ –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É? ‚Äî –î–∞, –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
‚Ä¢ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ–Ω–¥? ‚Äî –í—Å–µ —Ñ–æ–Ω–¥—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã

<b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞:</b>
–ï—Å–ª–∏ —É –≤–∞—Å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º, –æ–ø–∏—à–∏—Ç–µ –∏—Ö –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ.
            """,
            parse_mode="HTML",
            reply_markup=get_main_menu()
        )
    
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message()
async def text_handler(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.answer(
        "–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:\n\n"
        "/start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞\n"
        "/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        reply_markup=get_main_menu()
    )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    logger.info("Starting Sadaka-Pass Telegram Bot...")
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"Error starting bot: {e}")
    finally:
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main())
